/**
 * @file error_display.c
 * @brief Error message display for e-Paper using bitmap fonts
 */

#include "error_display.h"
#include "image_processor.h"
#include "epd_7in3e.h"
#include "esp_log.h"
#include "esp_heap_caps.h"
#include <string.h>
#include <stdio.h>

static const char *TAG = "ERR_DISP";

// Font dimensions (8x16 pixels per character)
#define FONT_WIDTH  8
#define FONT_HEIGHT 16

// Display dimensions
#define DISPLAY_WIDTH  800
#define DISPLAY_HEIGHT 480

// Layout constants
#define MARGIN_X       40
#define MARGIN_Y       60
#define LINE_SPACING   24
#define TITLE_SCALE    3   // 3x size for title (24x48 pixels)
#define BODY_SCALE     2   // 2x size for body text (16x32 pixels)

// 8x16 bitmap font for ASCII 32-126 (95 characters)
// Each character is 16 bytes (8 pixels wide x 16 pixels tall, 1 bit per pixel)
// Font data is stored MSB first (bit 7 = leftmost pixel)
static const uint8_t font_8x16[][16] = {
    // Space (32)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // ! (33)
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // " (34)
    {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // # (35)
    {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    // $ (36)
    {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
    // % (37)
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    // & (38)
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // ' (39)
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // ( (40)
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    // ) (41)
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    // * (42)
    {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    // + (43)
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    // , (44)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    // - (45)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // . (46)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // / (47)
    {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    // 0 (48)
    {0x00,0x00,0x38,0x6C,0xC6,0xC6,0xD6,0xD6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00},
    // 1 (49)
    {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    // 2 (50)
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // 3 (51)
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 4 (52)
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    // 5 (53)
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 6 (54)
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 7 (55)
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    // 8 (56)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 9 (57)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    // : (58)
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    // ; (59)
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    // < (60)
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    // = (61)
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // > (62)
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    // ? (63)
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // @ (64)
    {0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00},
    // A (65)
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // B (66)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    // C (67)
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    // D (68)
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    // E (69)
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // F (70)
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // G (71)
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    // H (72)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // I (73)
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // J (74)
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    // K (75)
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // L (76)
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // M (77)
    {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // N (78)
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // O (79)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // P (80)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // Q (81)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    // R (82)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // S (83)
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // T (84)
    {0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // U (85)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // V (86)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    // W (87)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    // X (88)
    {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // Y (89)
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // Z (90)
    {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // [ (91)
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    // \ (92)
    {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    // ] (93)
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    // ^ (94)
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // _ (95)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    // ` (96)
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // a (97)
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // b (98)
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    // c (99)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // d (100)
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // e (101)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // f (102)
    {0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // g (103)
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00},
    // h (104)
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // i (105)
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // j (106)
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    // k (107)
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    // l (108)
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // m (109)
    {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    // n (110)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    // o (111)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // p (112)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    // q (113)
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00},
    // r (114)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // s (115)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // t (116)
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    // u (117)
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // v (118)
    {0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0x00,0x00},
    // w (119)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    // x (120)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    // y (121)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00},
    // z (122)
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // { (123)
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    // | (124)
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    // } (125)
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    // ~ (126)
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

// Forward declarations
static void set_pixel(uint8_t *buffer, int x, int y, uint8_t color);
static void draw_char(uint8_t *buffer, int x, int y, char c, uint8_t color, int scale);
static void draw_string(uint8_t *buffer, int x, int y, const char *str, uint8_t color, int scale);
static void fill_rect(uint8_t *buffer, int x, int y, int w, int h, uint8_t color);
static void draw_rect(uint8_t *buffer, int x, int y, int w, int h, uint8_t color, int thickness);

/**
 * @brief Set a single pixel in the display buffer
 */
static void set_pixel(uint8_t *buffer, int x, int y, uint8_t color) {
    if (x < 0 || x >= DISPLAY_WIDTH || y < 0 || y >= DISPLAY_HEIGHT) return;

    // Each byte contains 2 pixels (4 bits each)
    // High nibble = even pixel, low nibble = odd pixel
    int byte_idx = (y * DISPLAY_WIDTH + x) / 2;
    if (x % 2 == 0) {
        buffer[byte_idx] = (buffer[byte_idx] & 0x0F) | (color << 4);
    } else {
        buffer[byte_idx] = (buffer[byte_idx] & 0xF0) | (color & 0x0F);
    }
}

/**
 * @brief Draw a single character at the specified position
 */
static void draw_char(uint8_t *buffer, int x, int y, char c, uint8_t color, int scale) {
    if (c < 32 || c > 126) c = '?';  // Replace unsupported chars
    int font_idx = c - 32;

    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t row_data = font_8x16[font_idx][row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            if (row_data & (0x80 >> col)) {
                // Draw scaled pixel
                for (int sy = 0; sy < scale; sy++) {
                    for (int sx = 0; sx < scale; sx++) {
                        set_pixel(buffer, x + col * scale + sx, y + row * scale + sy, color);
                    }
                }
            }
        }
    }
}

/**
 * @brief Draw a string at the specified position
 */
static void draw_string(uint8_t *buffer, int x, int y, const char *str, uint8_t color, int scale) {
    int cursor_x = x;
    int char_width = FONT_WIDTH * scale;

    while (*str) {
        if (*str == '\n') {
            cursor_x = x;
            y += FONT_HEIGHT * scale + 4;
        } else {
            // Check if character fits on line
            if (cursor_x + char_width > DISPLAY_WIDTH - MARGIN_X) {
                cursor_x = x;
                y += FONT_HEIGHT * scale + 4;
            }
            draw_char(buffer, cursor_x, y, *str, color, scale);
            cursor_x += char_width;
        }
        str++;
    }
}

/**
 * @brief Fill a rectangle with a color
 */
static void fill_rect(uint8_t *buffer, int x, int y, int w, int h, uint8_t color) {
    for (int py = y; py < y + h && py < DISPLAY_HEIGHT; py++) {
        for (int px = x; px < x + w && px < DISPLAY_WIDTH; px++) {
            set_pixel(buffer, px, py, color);
        }
    }
}

/**
 * @brief Draw a rectangle outline
 */
static void draw_rect(uint8_t *buffer, int x, int y, int w, int h, uint8_t color, int thickness) {
    // Top
    fill_rect(buffer, x, y, w, thickness, color);
    // Bottom
    fill_rect(buffer, x, y + h - thickness, w, thickness, color);
    // Left
    fill_rect(buffer, x, y, thickness, h, color);
    // Right
    fill_rect(buffer, x + w - thickness, y, thickness, h, color);
}

/**
 * @brief Categorize error message to determine error type
 */
error_type_t error_display_categorize(const char *error_msg) {
    if (error_msg == NULL) return ERROR_TYPE_UNKNOWN;

    // Check for initialization/memory errors
    if (strstr(error_msg, "allocate") || strstr(error_msg, "init") ||
        strstr(error_msg, "memory") || strstr(error_msg, "PSRAM")) {
        return ERROR_TYPE_INIT;
    }

    // Check for HTTP errors
    if (strstr(error_msg, "HTTP") || strstr(error_msg, "404") ||
        strstr(error_msg, "500") || strstr(error_msg, "status")) {
        return ERROR_TYPE_HTTP;
    }

    // Check for network errors
    if (strstr(error_msg, "network") || strstr(error_msg, "connect") ||
        strstr(error_msg, "WiFi") || strstr(error_msg, "DNS") ||
        strstr(error_msg, "timeout") || strstr(error_msg, "socket")) {
        return ERROR_TYPE_NETWORK;
    }

    // Check for image processing errors
    if (strstr(error_msg, "PNG") || strstr(error_msg, "decode") ||
        strstr(error_msg, "image") || strstr(error_msg, "format")) {
        return ERROR_TYPE_IMAGE;
    }

    return ERROR_TYPE_UNKNOWN;
}

/**
 * @brief Get title string for error type
 */
static const char* get_error_title(error_type_t error_type) {
    switch (error_type) {
        case ERROR_TYPE_INIT:    return "INIT ERROR";
        case ERROR_TYPE_NETWORK: return "NETWORK ERROR";
        case ERROR_TYPE_HTTP:    return "HTTP ERROR";
        case ERROR_TYPE_IMAGE:   return "IMAGE ERROR";
        default:                 return "ERROR";
    }
}

/**
 * @brief Get suggestion string for error type
 */
static const char* get_error_suggestion(error_type_t error_type) {
    switch (error_type) {
        case ERROR_TYPE_INIT:
            return "Device may need restart";
        case ERROR_TYPE_NETWORK:
            return "Check WiFi connection";
        case ERROR_TYPE_HTTP:
            return "Check image URL settings";
        case ERROR_TYPE_IMAGE:
            return "Check image format (PNG)";
        default:
            return "Check configuration";
    }
}

/**
 * @brief Render an error screen to the display buffer
 */
void error_display_render(uint8_t *buffer, error_type_t error_type, const char *error_detail) {
    // Fill background with white
    memset(buffer, 0x11, IMAGE_BUFFER_SIZE);  // 0x11 = white pixels (both nibbles)

    // Draw border rectangle
    draw_rect(buffer, 20, 20, DISPLAY_WIDTH - 40, DISPLAY_HEIGHT - 40, EPD_7IN3E_BLACK, 3);

    // Draw header bar
    fill_rect(buffer, 23, 23, DISPLAY_WIDTH - 46, 70, EPD_7IN3E_RED);

    // Draw title (white on red background)
    const char *title = get_error_title(error_type);
    int title_width = strlen(title) * FONT_WIDTH * TITLE_SCALE;
    int title_x = (DISPLAY_WIDTH - title_width) / 2;
    draw_string(buffer, title_x, 35, title, EPD_7IN3E_WHITE, TITLE_SCALE);

    // Draw error detail if provided
    int y_pos = 120;
    if (error_detail && error_detail[0] != '\0') {
        // Truncate long messages
        char detail_buf[100];
        strncpy(detail_buf, error_detail, sizeof(detail_buf) - 1);
        detail_buf[sizeof(detail_buf) - 1] = '\0';

        draw_string(buffer, MARGIN_X, y_pos, "Details:", EPD_7IN3E_BLACK, BODY_SCALE);
        y_pos += FONT_HEIGHT * BODY_SCALE + 8;
        draw_string(buffer, MARGIN_X + 20, y_pos, detail_buf, EPD_7IN3E_BLUE, BODY_SCALE);
        y_pos += FONT_HEIGHT * BODY_SCALE + 40;
    }

    // Draw suggestion
    const char *suggestion = get_error_suggestion(error_type);
    draw_string(buffer, MARGIN_X, y_pos, "Suggestion:", EPD_7IN3E_BLACK, BODY_SCALE);
    y_pos += FONT_HEIGHT * BODY_SCALE + 8;
    draw_string(buffer, MARGIN_X + 20, y_pos, suggestion, EPD_7IN3E_GREEN, BODY_SCALE);

    // Draw footer
    y_pos = DISPLAY_HEIGHT - 80;
    draw_string(buffer, MARGIN_X, y_pos, "Press BOOT button to access settings", EPD_7IN3E_BLACK, 1);

    ESP_LOGI(TAG, "Error screen rendered: %s", title);
}

/**
 * @brief Display an error screen directly on the e-paper
 */
esp_err_t error_display_show(error_type_t error_type, const char *error_detail) {
    // Allocate buffer in PSRAM
    uint8_t *buffer = heap_caps_malloc(IMAGE_BUFFER_SIZE, MALLOC_CAP_SPIRAM);
    if (buffer == NULL) {
        ESP_LOGE(TAG, "Failed to allocate error display buffer");
        return ESP_ERR_NO_MEM;
    }

    // Render error screen
    error_display_render(buffer, error_type, error_detail);

    // Display on e-paper
    epd_7in3e_display(buffer);

    // Free buffer
    heap_caps_free(buffer);

    ESP_LOGI(TAG, "Error screen displayed");
    return ESP_OK;
}

